# Samba

## Общая информация

Samba -- это набор служб и библиотек, обеспечивающий работу UNIX-like
систем в качестве файл-сервера, совместимого с ОС Windows по
протоколу SMB (Server Message Block), также известному как CIFS
(Common Internet FileSystem). Подробнее об этом протоколе см.
[статью](https://ru.wikipedia.org/wiki/Server_Message_Block) на
википедии.

На сегодня (2014 г.) существует две распространенных версии этого
пакета: Samba 3 и Samba 4. В четвертой версии добавлена
возможность работы сервера в режиме контроллера домена Active
Directory, совместимого с Windows 2003. Samba 3 умеет только работу в
режиме рядового сервера домена (member server), а также работу в
режиме контроллера домена уровня NT.

## Службы Samba

Основными программами пакета samba-server являются smbd и nmbd. Первая
занимается собственно обслуживанием запросов от клиентов, вторая
обеспечивает отклик на запросы NetBIOS и участвует в протоколах
общения "обозревателя сети", благодаря которому составляется список
машин в локальной сети.

Кроме этих программ, обеспечивающих базовую функциональность
samba-сервера, существует также утилита под названием WinBind. Эта
служба обеспечивает составление списка пользователей и групп в случае,
когда в сети существует доменная структура. В такой конфигурации при
запросе доступа к ресурсу проверку имени пользователя и пароля
осуществляет эта служба. Также при помощи этой службы и
соответствующих библиотек можно, например, настроить сервер
таким образом, что в систему можно залогиниться при помощи доменной
учетной записи.

## Настройка сервера

Основным конфигурационным файлом является smb.conf, располагающийся
обычно в /etc/samba/smb.conf (Linux) или /usr/local/etc/smb.conf
(FreeBSD). Он отвечает за настройку поведения всех перечисленных выше
служб, а также клиента samba. Обычно в нем уже сделана минимальная
настройка, позволяющая увидеть компьютер по сети с машин Windows, но
никаких ресурсов не настроено, и режим работы - standalone server. В
десктопных дистрибутивах, предполагающих наличие графического сервера
с окружением Gnome или KDE может быть включена настройка usershare path,
позволяющая непривилегированным пользователям, не имеющим прав на
редактирование smb.conf, создавать свои общие ресурсы при помощи
команды net share add, либо при помощи графического окружения.

В Интернете существует множество руководств по настройке сервера Samba,
но я бы не рекомендовал ими пользоваться, поскольку в них редко
содержится построчное описание каждой конфигурационной опции, и
часто встречаются непонятно зачем внесенные строки. Гораздо лучше
прочитать руководство (man smb.conf), в котором содержится
исчерпывающая информация, во многих случаях с примерами. Если с
английским тяжело, есть [перевод](http://smb-conf.ru) большинства
(возможно, даже всех) конфигурационных опций.

### Краткое описание формата файла

Файл smb.conf по синтаксису напоминает ini файл, в котором названия
секций заключены в квадратные скобки, а строки комментариев
начинаются с символов "\#" либо ";". Каждый ресурс, который
будет доступен на сервере, определяется секцией в этом файле с
именем этого ресурса. То есть если мы хотим создать общий ресурс с
именем Share, нужно определить секцию `[Share]`. Кроме того, если
несколько специальных секций: global, homes, printers. Они
определяют, соответственно, глобальные параметры сервера,
домашние директории пользователей, специальный ресурс для
совместного доступа к принтерам, подключенным к серверу Samba.

### Особенности проверки паролей

В работе сервера samba есть особый момент, связанный с проверкой
паролей. Дело в том, что в серьезных продуктах (в том числе в ОС
Windows, Linux, и других Unix-like) пароль никогда не хранится в виде
открытого текста или обратимого шифра от него. Вместо этого
используется хэш пароля, и при проверке сравнивается хэш от
введенного пароля с хэшем, хранящимся в базе паролей. Проблема
заключается в том, что хэши (алгоритмы), используемые в Unix, и
хэши, используемые в SMB, разные. В итоге проверка пароля стандартными
средствами оказывается невозможна. В случае, когда есть домен, с этим
немного проще, так как проверкой пароля занимается контроллер домена,
ему нужно лишь передать данные. Но в режиме standalone server такой
возможности нет, нужно уметь проверять пароли у себя. Поэтому для
samba существует отдельная база пользователей и утилита smbpasswd,
которая управляет ей. Однако, при помощи smbpasswd можно добавлять
в эту базу пользователей, не существующих в системе. В этом случае
возникает вопрос, что делать с правами на доступ к файлам. Тут
тоже есть два решения. Первое называется user map, когда
определяется сопоставление пользователей samba с системными
пользователями. Второе -- назначить на ресурсе фиксированного
пользователя (force user), и в этом случае при логине
требуется указать только корректную пару логин-пароль, а дальше
ему будут назначены права указанного пользователя.

### Особенности взаимодействия unix

Если и сервер, и клиент поддерживают расширения Unix, то помимо всей
остальной информации клиенту передается также информация о правах
доступа к файлам, и UID/GID владелца файлов. Это значит, что если
базы данных пользователей на сервере и клиенте различаются, то права
и владельцы файлов не будут соответствовать. Из-за этого возникают
разные спецэффекты, когда подмонтированный в директорию ресурс
отображается со странными владельцами файлов, типа wwwrun:vboxusers,
или вообще из-за отсутствия указанных UID в /etc/passwd вместо имен
отображаются числовые значения. Здесь есть несколько вариантов.
Во-первых, поддерживать базу пользователей в одинаковом состоянии на
всех unix машинах, общающихся между собой. Это может быть неудобно по
разным причинам, а может быть наоборот, самым простым вариантом,
особенно если есть домен. Во-вторых, можно использовать параметры
монтирования ресурса cifs forceuid и forcegid -- тогда все файлы и
директории будут отображаться принадлежащими указанным uid и gid,
но стоит учесть, что в этом случае фактические права доступа могут
отличаться от отображаемых на клиенте. В-третьих, можно отключить
unix extensions, в этом случае становятся недоступны различные
расширенные возможности, такие как передача символических и
жестких ссылок.

### Основные настройки

В документации по smb.conf напротив каждого параметра есть флаг G или S,
который указывает, где может встречаться этот параметр: в глобальной
конфигурации сервера (G), либо в конфигурации отдельного ресурса
(S).

Начнем с глобального параметра security (безопасность). Он является
основным параметром, определяющим работу сервера, и может иметь
значения user, share, server, domain или ads. В samba версии 4
значения server и share убраны как устаревшее. По умолчанию сервер
работает в режиме security = user. Это значит, что разрешения на доступ
к ресурсу определяются по отношению к пользователям или группам
пользователей, а авторизация пользователей происходит по паролю.
В устаревшем режиме security = share доступ к ресурсу осуществлялся
исключительно по паролю, то есть для доступа нужно было знать
только название ресурса и пароль от него. Режимы domain и ads
используются при наличии доменной структуры в сети, и с точки
зрения клиента работают аналогично security = user, но сервер
проверяет пароль, общаясь с контроллером домена. В случае security
= domain, если указана опция domain logons = yes, сервер выступает в
роли контроллера домена NT. Режим security = server использовался в
древние времена, когда samba не могла работать в режиме сервера-члена
домена.

В samba 4 есть еще параметр server role (роль сервера). По умолчанию
(или когда значение равно auto) выбирается в соответствии с
параметром security. Обычно изменение этого параметра на
требуется. Возможные варианты: standalone (отдельный сервер),
member server (член домена), classic primary domain controller, netbios
backup domain controller, active directory domain comntoller.

Следующие параметры влияют на именование машины. Это workgroup, netbios
name, realm и server string. Тут все довольно очевидно, кроме последних
двух. Опция realm задает используемую область kerberos для active
directory, и чаще всего совпадает с DNS-именем сервера kerberos домена
AD. Server string -- строка комментария к серверу, отображаемая рядом с
его именем в обозревателе, на работу сервера в остальном не влияет
никак.
